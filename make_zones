#!/usr/bin/perl
use strict;
use File::Find::Rule;
use File::Basename ;
use File::Path;
use Carp;

# we expect that you've generated the zone as .ics files into a
# directory called zoneinfo using Vzic
# http://dialspace.dial.pipex.com/prod/dialspace/town/pipexdsl/s/asbm26/vzic/

for my $infile (find( file => name => '*.ics', in => 'zoneinfo' )) {
    my $zone = $infile;
    $zone =~ s{^zoneinfo/}{};
    $zone =~ s{\.ics$}{};
    my $module = "Data::ICal::TimeZone::Object::$zone";
    $module =~ s{/}{::}g;
    my $outfile = "lib/$module.pm";
    $outfile =~ s{::}{/}g;
    #print "$zone => $module => $outfile\n";
    mkpath [ dirname $outfile ];
    open my $out, '>',  $outfile or croak "open $outfile $!";
    open my $in, '<', $infile or croak "open $infile $1";
    print {$out} <<"END";
# this class is autogenerated.  use make_zones to regenerate
package $module;
use strict;
use base qw( Data::ICal::TimeZone::Object );

__PACKAGE__->new->_load( join '', <DATA> );

1;
__DATA__
END

    my @ics = <$in>;
    for (@ics) {
       s{^TZID:/myorganization.org/.*?/}{TZID:}; # fixup bizarro TZID
    }
    print {$out} @ics;
}
